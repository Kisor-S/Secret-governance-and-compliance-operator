name: CI/CD

on:
    push:
        branches:
            - main
        tags:
            - 'v*.*.*'
    pull_request:
        branches:
            - main

jobs:
    build-test-lint:
        name: Build, Test, and Lint
        runs-on: ubuntu-latest

        steps:
            - name: Checkout code
              uses: actions/checkout@v4

            - name: Setup Go
              uses: actions/setip-go@v5
              with:
                go-version-file: go.mod
            
            - name: Cache Go modules
              uses: actions/cache@v4
              with:
                path: |
                  ~/go/pkg/mod
                  ~/.cache/go-build
                key: ${{ runner.os }}-go-${{ hashFiles('**/go.sum') }}
                restore-keys: |
                  ${{ runner.os }}-go-

            # Install local tools (kubebuilder, controller-gen)
            - name: Install Kubebuilder
              run: |
                curl -L https://github.com/kubernetes-sigs/kubebuilder/releases/latest/download/kubebuilder_$(go env GOOS)_$(go env GOARCH) -o kubebuilder
                chmod +x kubebuilder
                sudo mv kubebuilder /usr/local/bin/
                  
            # Lint using golangci-lint
            - name: Run GolangCI-Lint
              uses: golangci/golangci-lint-action@v6
              with:
                version: v1.56.2
                args: --timeout=5m

            - name: Run Make Generate
              run: make generate

            - name: Run Make Manifests
              run: make manifests
            
            - name: Run Unit Tests
              env:
                CGO_ENABLED: 0
              run: go test ./... -v 
              
            - name: Build the Operator Binary
              run: go build -o bin/manager main.go

    docker-build:
        
        name: Build and Push Docker Image
        runs-on: ubuntu-latest
        needs: build-test-lint

        if: github.ref == 'refs/heads/main' || startsWith(github.ref, 'refs/tags/')

        steps:
            - name: Checkout code
              uses: actions/checkout@v4

            - name: Set up Docker Buildx
              uses: docker/setup-buildx-action@v3

            - name: Login to GHCR
              uses: docker/login-action@v3
              with:
                registry: ghcr.io
                username: ${{ github.actor }}
                password: ${{ secrets.GITHUB_TOKEN }}

            - name: Extract Version
              id: version
              run: |
                if [[ "${GITHUB_REF}" == refs/tags/* ]]; then
                    echo "version=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT
                else
                    echo "version=latest" >> $GITHUB_OUTPUT
                fi

            - name: Build and Push Docker Image
              uses: docker/build-push-action@v6
              with:
                context: .
                file: Dockerfile
                push: true
                tags: |
                    ghcr.io/${{ github.repository_owner }}/secret-policy-operator:${{ steps.version.outputs.version }}
                    ghcr.io/${{ github.repository_owner }}/secret-policy-operator:latest